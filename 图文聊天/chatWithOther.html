<!DOCTYPE HTML>
<html>
   <head>
   <meta charset="utf-8">
   <title>baoge聊天室</title>
	<script src="jquery.js"></script>
      <script type="text/javascript">
       // register();
        // localStorage.setItem("key", "mocha"); 
        // var st = localStorage.getItem("key");
        // alert(st);

      $(function(){
          
           $("#send").click(function(){
           var chatData = $("#chatData").val();

           $("#message").after(
             "<div style='float:right'>"+chatData+"</div><br/>"
            );
           var str=location.href;             
           var num=str.indexOf("?");
           //friend id
           var fid = str.substr(num+5);
           var token = localStorage.getItem("mytoken");
           // var toID =  
           // console.log(sex);
           var data  = {"action":"sendOne","fid":fid,"token":token,"chatData":chatData};
           
           register(JSON.stringify(data));
           	});

      	});
 

       function register(data){
       	var ws = new WebSocket("ws://192.168.8.128:9503");
          ws.onopen = function()
               {
                  // Web Socket 已连接上，使用 send() 方法发送数据
                  ws.send(data);
                  console.log("数据发送中..."+data);
               };
				
               ws.onmessage = function (evt) 
               { 
                  console.log(evt.data);
                  var received_msg = JSON.parse(evt.data);
                  var action = (received_msg.action);
                  console.log(received_msg + "---" + action);
                  
                  switch(action){
                   

                    case 'sendOne':
                      console.log('sendOne');
                      break;
                    
                    //有人给我发信息
                    case 'acceptOne':
                    console.log('acceptOne');
                    console.log(received_msg);

                    $("#message").after(
                     "<div style='float:left'>"+ received_msg.content+"</div><br/>"
                      );
                      break;


                    case 'onlineData':

                    // var myid = $("#myid").html();
                     var myid = localStorage.getItem("myid");
                    console.log(myid+' my id is');
                     var onlineData = received_msg.data;
                  // console.log(onlineData);
                  var onlineList = onlineData;
                  var onlineContent = '';
                  for(var i=0;i<onlineList.length;i++){
                      
                      //不能自己与自己聊天
                      if (onlineList[i] != myid) {
                         onlineContent += 
                        '<a href=chatWithOther.html?fid='+ onlineList[i] 
                          +'>和他聊天'
                          + onlineList[i]
                          +' </a>'
                          +'<br/>';
                      }
                       
                  }
                  $("#online").html(onlineContent);
                    break;
                  }
                 
                 
               };
				
               ws.onclose = function()
               { 
                  // 关闭 websocket
                  console.log("连接已关闭..."); 
               };

       }
        
      </script>
		
   </head>
   <body>
   
      <div id="sse">
      
      <div id="message">
      </div>
      <br>
      <br>
      发送聊天内容:<input type="text" name="chatData" id="chatData">
      <BUTTON id="send">发送</BUTTON>
      <div>
       在线的人:<br/>
       <div id="online">
       </div>
      </div>

      
      </div>
      
   </body>
</html>